stages:
    - static_check
    - test
    - build

image: $CI_REGISTRY/cps/commonroad-scenario-designer/ci:v0.6.9_20.04

.install-and-run: &install-and-run
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.lrz.de/".insteadOf "git@gitlab.lrz.de:"
  - pip install -r ./tests/test_requirements.txt
  - pip install -e .
  - git clone git@gitlab.lrz.de:cps/sumo-interface.git $HOME/sumo-interface
  - cd $HOME/sumo-interface
  - git checkout fac8334df357a7599ccc51e5ae5aeee9c82d9cb5
  - cd /builds/cps/commonroad-scenario-designer
  - pip uninstall -y sumocr
  - pip install -e "$HOME"/sumo-interface
  - pip install commonroad-io==2022.2
  - coverage run --source ./crdesigner -m pytest tests/
  - coverage report -m || true

# static_check
prospector_source:
  stage: static_check
  image: "python:3.11"
  script:
    - pip install prospector[with_mypy]
    - prospector crdesigner/
  allow_failure: true

prospector_test:
  stage: static_check
  image: "python:3.11"
  script:
    - pip install prospector[with_mypy]
    - prospector tests/
  allow_failure: true

prospector_tutorials:
  stage: static_check
  image: "python:3.11"
  script:
    - pip install prospector[with_mypy]
    - prospector tutorials/
  allow_failure: true
#
#python37:
#    stage: test
#    variables:
#      QT_QPA_PLATFORM: "offscreen"
#    script:
#        - source activate cr37
#        - *install-and-run
#
#python38:
#    stage: test
#    variables:
#      QT_QPA_PLATFORM : "offscreen"
#    script:
#        - source activate cr38
#        - *install-and-run
#
#python39:
#    stage: test
#    variables:
#      QT_QPA_PLATFORM : "offscreen"
#    script:
#        - source activate cr39
#        - *install-and-run
#        - coverage xml
#    coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
#    artifacts :
#      reports :
#        coverage_report :
#          coverage_format : cobertura
#          path : coverage.xml
#
##python310 :
##  stage : test
##  variables :
##    QT_QPA_PLATFORM : "offscreen"
##  script :
##    - source activate cr310
##    - *install-and-run
#
#docs:
#    stage: test
#    script:
#        - source activate cr39
#        - pip install -e .
#        - pip install -r ./docs/doc_requirements.txt
#        - cd docs && bash ./docs_build_script.sh
#    artifacts:
#      paths :
#        - ./docs/build/
#      expose_as: 'Documentation'
#
#build_package:
#    stage: build
#    only:
#        - master
#        - develop
#    script:
#        - source activate cr39
#        - python setup.py sdist bdist_wheel
