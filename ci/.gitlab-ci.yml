stages:
    - static_check
    - test
    - build_deploy

image: $CI_REGISTRY/cps/commonroad-scenario-designer/ci:v0.7.4

.install-and-run: &install-and-run
  - pip install -r ./requirements.txt
  - pip install -r ./tests/test_requirements.txt
  - pip install -e .
  - coverage run --source ./crdesigner -m pytest tests/
  - coverage report -m || true

# static_check
prospector_source:
  stage: static_check
  image: "python:3.11"
  script:
    - pip install prospector[with_mypy]
    - prospector crdesigner/
  allow_failure: true
  needs: []

prospector_test:
  stage: static_check
  image: "python:3.11"
  script:
    - pip install prospector[with_mypy]
    - prospector tests/
  allow_failure: true
  needs: []

prospector_tutorials:
  stage: static_check
  image: "python:3.11"
  script:
    - pip install prospector[with_mypy]
    - prospector tutorials/
  allow_failure: true
  needs: []

python38:
    stage: test
    variables:
      QT_QPA_PLATFORM : "offscreen"
    script:
      - source activate cr38
      - *install-and-run
    needs: []

python39:
    stage: test
    variables:
      QT_QPA_PLATFORM : "offscreen"
    script:
      - source activate cr39
      - *install-and-run
    needs: []

python310:
  stage : test
  variables :
    QT_QPA_PLATFORM : "offscreen"
  script :
    - source activate cr310
    - *install-and-run
    - coverage xml
  coverage : '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts :
    reports :
      coverage_report :
        coverage_format : cobertura
        path : coverage.xml
  needs : [ ]

docs:
    stage: build_deploy
    image: "python:3.11"
    script:
        - pip install -e .
        - pip install -r ./requirements.txt
        - pip install -r ./docs/doc_requirements.txt
        - cd docs && bash ./docs_build_script.sh
    artifacts:
      paths :
        - ./docs/build/
      expose_as: 'Documentation'
    needs: []

build_package:
    stage: build_deploy
    image: "python:3.11"
    only:
        - master
        - develop
    script:
        - pip install -v .
    needs: []

push_to_external_pipy_test_registry:
  stage: build_deploy
  image: "python:3.11"
  when: manual
  only:
    - master
  script:
    - pip install twine
    - python3 setup.py sdist bdist_wheel
    - twine upload -u $CR_PYPI_TEST_USERNAME -p $CR_PYPI_TEST_PASSWORD --repository-url https://test.pypi.org/legacy/ dist/*

push_to_external_pipy_release_registry:
  stage: build_deploy
  image: "python:3.11"
  when: manual
  only:
    - master
  script:
    - pip install twine
    - python3 setup.py sdist bdist_wheel
    - twine upload -u $CR_PYPI_RELEASE_USERNAME -p $CR_PYPI_RELEASE_PASSWORD dist/*
